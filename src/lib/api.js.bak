import axios from 'axios'

// src/lib/api.js - CORRIJA A BASE URL

// âœ… ConfiguraÃ§Ã£o CORRIGIDA - usa proxy em desenvolvimento
const getApiBaseUrl = () => {
  // Desenvolvimento: usa proxy do Vite (/api â†’ localhost:5000)
  if (import.meta.env.DEV) {
    return '/api'  // âœ… MUDOU para /api
  }
  
  // ProduÃ§Ã£o: usa URL do ambiente
  return import.meta.env.VITE_API_URL || ''
}

const API_BASE_URL = getApiBaseUrl()

console.log('ðŸŒ API Base URL:', API_BASE_URL)
console.log('ðŸ”§ Ambiente:', import.meta.env.MODE)

const api = axios.create({
  baseURL: API_BASE_URL,
  withCredentials: true,
  headers: {
    'Content-Type': 'application/json',
  },
  timeout: 30000,
})

// ... resto do cÃ³digo permanece igual

// âœ… Interceptor de Request Melhorado
api.interceptors.request.use(
  (config) => {
    // Log detalhado em desenvolvimento
    if (import.meta.env.DEV) {
      console.log(`ðŸŒ [API] ${config.method?.toUpperCase()} ${config.baseURL || ''}${config.url}`, {
        data: config.data,
        params: config.params
      })
    }
    return config
  },
  (error) => {
    console.error('âŒ [API] Erro na configuraÃ§Ã£o da requisiÃ§Ã£o:', error)
    return Promise.reject(error)
  }
)

// âœ… Interceptor de Response Melhorado
api.interceptors.response.use(
  (response) => {
    // Log em desenvolvimento
    if (import.meta.env.DEV) {
      console.log(`âœ… [API] ${response.status} ${response.config.method?.toUpperCase()} ${response.config.url}`)
    }
    return response
  },
  (error) => {
    // âœ… Tratamento de erros mais detalhado
    if (error.code === 'ECONNABORTED') {
      console.error('âŒ [API] Timeout - Servidor nÃ£o respondeu em 30s')
    } else if (error.response) {
      // Servidor respondeu com erro
      const { status, data } = error.response
      const method = error.config?.method?.toUpperCase()
      const url = error.config?.url
      
      console.group(`âŒ [API] Erro ${status} ${method} ${url}`)
      console.log('Resposta:', data)
      console.groupEnd()
      
      // Tratamento especÃ­fico por status
      switch (status) {
        case 401:
          console.warn('âš ï¸ [API] NÃ£o autenticado - redirecionando para login')
          // Opcional: disparar evento global de logout
          break
        case 403:
          console.warn('âš ï¸ [API] Acesso negado - sem permissÃµes')
          break
        case 404:
          console.warn('âš ï¸ [API] Endpoint nÃ£o encontrado')
          break
        case 429:
          console.warn('âš ï¸ [API] Muitas requisiÃ§Ãµes - rate limiting')
          break
        case 500:
          console.error('âŒ [API] Erro interno do servidor')
          break
        case 502:
        case 503:
        case 504:
          console.error('âŒ [API] Servidor indisponÃ­vel')
          break
        default:
          console.error(`âŒ [API] Erro ${status}`)
      }
    } else if (error.request) {
      // RequisiÃ§Ã£o foi feita mas nÃ£o houve resposta
      console.error('âŒ [API] Sem resposta do servidor - verifique:', {
        url: error.config?.url,
        baseURL: error.config?.baseURL,
        message: 'Verifique se o backend estÃ¡ rodando e acessÃ­vel'
      })
    } else {
      // Erro na configuraÃ§Ã£o da requisiÃ§Ã£o
      console.error('âŒ [API] Erro de configuraÃ§Ã£o:', error.message)
    }
    
    return Promise.reject(error)
  }
)

// âœ… Helper para verificar saÃºde da API
export const checkApiHealth = async () => {
  try {
    const response = await api.get('/health')
    console.log('ðŸ¥ [API] Health check:', response.data)
    return response.data
  } catch (error) {
    console.error('âŒ [API] Health check falhou:', error)
    throw error
  }
}

// âœ… Helper para testar conectividade
export const testConnection = async () => {
  try {
    const startTime = Date.now()
    const response = await api.get('/health')
    const endTime = Date.now()
    
    return {
      success: true,
      status: response.status,
      responseTime: `${endTime - startTime}ms`,
      data: response.data
    }
  } catch (error) {
    return {
      success: false,
      error: error.message,
      code: error.code
    }
  }
}

export default api